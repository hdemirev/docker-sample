<html>
    <body>
        <h1>Hello!</h1>
        <p>This is a FREE TIER!!!! ðŸŽ‰ðŸŽ‰ðŸŽ‰ service that allows you to run arbitrary queries against a pg database. When you submit a query, a one-off job is created that runs it and stores the results (in the same database, lol.)</p>

        <textarea style="width: 400px; height: 200px;" id="query-text"></textarea>
        <button onclick="submit()">Submit</button>

        <div id="response-area"></div>

        <script>
            let jobId = ""
            let checkInterval = null
            let queryStart = null
            const submit = async() => {
                if(checkInterval){
                    clearInterval(checkInterval)
                }
                const data = {query: document.getElementById("query-text").value};
                queryStart = new Date()
                const res = await fetch("/new-request", {
                    method: "POST", 
                    headers: {
                    'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                const responseData = await res.json()
                jobId = responseData.jobId
                const responseArea = document.getElementById('response-area')
                const newNode = document.createElement("P")
                newNode.innerText = `Query submitted at: ${new Date().toLocaleTimeString()} (${jobId})`
                responseArea.prepend(newNode)

                checkInterval = setInterval(()=>{
                    checkJob(jobId)
                }, 1000)

            }
            const checkJob = async(id) => {
                const checkStart = new Date()
                const res = await fetch(`/check-request?id=${id}`)
                const data = await res.json()
                const responseArea = document.getElementById('response-area')
                const newNode = document.createElement("P")
                console.log(data)
                if(data.result){
                    const queryEnd = new Date(data.finishedAt)
                    const queryTime = (queryEnd - queryStart) / 1000
                    const finishedNode = document.createElement("P")
                    finishedNode.innerText = `Query completed in ${queryTime} seconds`
                    responseArea.prepend(finishedNode)
                    newNode.innerText = JSON.stringify(data.result.responseData)
                    responseArea.prepend(newNode)
                    if(checkInterval){
                        clearInterval(checkInterval)
                    }
                } else {
                    newNode.innerText = `Checked at: ${checkStart.toLocaleTimeString()} and query has not finished`
                    responseArea.prepend(newNode)
                }
            }
        </script>
    </body>
</html>